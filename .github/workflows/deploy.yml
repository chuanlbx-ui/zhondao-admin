name: ç®¡ç†åå°éƒ¨ç½²å·¥ä½œæµ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20.x'

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡Œ ESLint
      run: npm run lint || echo "linting skipped"

    - name: è¿è¡Œç±»å‹æ£€æŸ¥
      run: npx tsc --noEmit || echo "type checking skipped"

    - name: æ„å»ºåº”ç”¨
      run: npm run build
      env:
        VITE_API_BASE_URL: ${{ secrets.ADMIN_API_BASE_URL }}
        VITE_ENVIRONMENT: production

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: admin-build-files
        path: dist/
        retention-days: 7

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: admin-build-files
        path: dist/

    - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'dist/'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  deploy-staging:
    name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: staging

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: admin-build-files
        path: dist/

    - name: éƒ¨ç½²åˆ° Vercel (é¢„å‘å¸ƒ)
      uses: vercel/action@v1
      with:
        vercel-token: ${{ secrets.VERCEL_ADMIN_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_ADMIN_PROJECT_ID }}
      env:
        VERCEL_ENV: preview

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: admin-build-files
        path: dist/

    - name: éƒ¨ç½²åˆ° Vercel (ç”Ÿäº§)
      uses: vercel/action@v1
      with:
        vercel-token: ${{ secrets.VERCEL_ADMIN_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_ADMIN_PROJECT_ID }}
        vercel-args: '--prod'
      env:
        VERCEL_ENV: production

    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: |
          ğŸ¯ ç®¡ç†åå°éƒ¨ç½²å®Œæˆ
          ç¯å¢ƒ: Production
          åˆ†æ”¯: ${{ github.ref_name }}
          æäº¤: ${{ github.sha }}
          éƒ¨ç½²çŠ¶æ€: ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶æœåŠ¡å™¨ (å¤‡é€‰æ–¹æ¡ˆ)
  deploy-static:
    name: éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.event.inputs.environment == 'production'
    environment: production

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: admin-build-files
        path: dist/

    - name: æ·»åŠ å®‰å…¨å¤´é…ç½®
      run: |
        cat > dist/_headers << EOF
        /*
          X-Frame-Options: DENY
          X-Content-Type-Options: nosniff
          X-XSS-Protection: 1; mode=block
          Referrer-Policy: strict-origin-when-cross-origin
          Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'
        EOF

    - name: éƒ¨ç½²åˆ°é™æ€æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.STATIC_HOST }}
        username: ${{ secrets.STATIC_USERNAME }}
        key: ${{ secrets.STATIC_SSH_KEY }}
        source: "dist/*"
        target: ${{ secrets.STATIC_ADMIN_PATH }}
        strip_components: 1

    - name: æ¸…ç†CDNç¼“å­˜
      run: |
        curl -X POST "${{ secrets.CDN_API_URL }}/invalidate" \
          -H "Authorization: Bearer ${{ secrets.CDN_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"paths": ["/admin/*"]}'

  # éƒ¨ç½²åå®‰å…¨éªŒè¯
  security-validation:
    name: éƒ¨ç½²åå®‰å…¨éªŒè¯
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
    - name: ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
      run: sleep 60

    - name: å®‰å…¨å¤´æ£€æŸ¥
      run: |
        for url in "${{ secrets.ADMIN_STAGING_URL }}" "${{ secrets.ADMIN_PRODUCTION_URL }}"; do
          if [ -n "$url" ]; then
            echo "æ£€æŸ¥: $url"
            response=$(curl -s -I "$url")

            if echo "$response" | grep -q "X-Frame-Options:"; then
              echo "âœ… X-Frame-Options å¤´å·²è®¾ç½®"
            else
              echo "âŒ X-Frame-Options å¤´ç¼ºå¤±"
            fi

            if echo "$response" | grep -q "X-Content-Type-Options:"; then
              echo "âœ… X-Content-Type-Options å¤´å·²è®¾ç½®"
            else
              echo "âŒ X-Content-Type-Options å¤´ç¼ºå¤±"
            fi
          fi
        done

    - name: ç®¡ç†åå°è®¿é—®æƒé™æ£€æŸ¥
      run: |
        # æ£€æŸ¥æœªæˆæƒè®¿é—®æ˜¯å¦è¢«æ­£ç¡®é˜»æ­¢
        response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.ADMIN_PRODUCTION_URL }}/api/users")
        if [ $response -eq 401 ] || [ $response -eq 403 ]; then
          echo "âœ… API è®¿é—®æ§åˆ¶æ­£å¸¸"
        else
          echo "âš ï¸ API è®¿é—®æ§åˆ¶å¯èƒ½å­˜åœ¨é—®é¢˜: HTTP $response"
        fi

  # ç®¡ç†åå°å¥åº·æ£€æŸ¥
  health-check:
    name: ç®¡ç†åå°å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
    - name: æ£€æŸ¥é¢„å‘å¸ƒç¯å¢ƒ
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.ADMIN_STAGING_URL }}")
        if [ $response -eq 200 ]; then
          echo "âœ… ç®¡ç†åå°é¢„å‘å¸ƒç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ ç®¡ç†åå°é¢„å‘å¸ƒç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $response"
          exit 1
        fi

    - name: æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ
      if: needs.deploy-production.result == 'success'
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.ADMIN_PRODUCTION_URL }}")
        if [ $response -eq 200 ]; then
          echo "âœ… ç®¡ç†åå°ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ ç®¡ç†åå°ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $response"
          exit 1
        fi

    - name: å…³é”®åŠŸèƒ½æ£€æŸ¥
      run: |
        # æ£€æŸ¥ç®¡ç†åå°å…³é”®èµ„æº
        response=$(curl -s "${{ secrets.ADMIN_PRODUCTION_URL }}")

        # æ£€æŸ¥ç™»å½•é¡µé¢
        if echo "$response" | grep -q "login\|Login"; then
          echo "âœ… ç™»å½•é¡µé¢æ­£å¸¸"
        else
          echo "âŒ ç™»å½•é¡µé¢å¼‚å¸¸"
          exit 1
        fi

        # æ£€æŸ¥ç®¡ç†ç•Œé¢
        if echo "$response" | grep -q "dashboard\|Dashboard"; then
          echo "âœ… ç®¡ç†ç•Œé¢æ­£å¸¸"
        else
          echo "âš ï¸ ç®¡ç†ç•Œé¢å¯èƒ½éœ€è¦ç™»å½•è®¿é—®"
        fi